!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i=t();for(var s in i)("object"==typeof exports?exports:e)[s]=i[s]}}(self,(()=>(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Run:()=>Run});class i{path;asset;constructor(e,t){this.path=e,this.asset=t}directory(){const e=this.path.lastIndexOf("/");return-1===e?"":this.path.substring(0,e+1)}resolveDependencies(e){null!==this.asset&&void 0!==this.asset&&"function"==typeof this.asset.resolveDependencies&&this.asset.resolveDependencies(this,e)}}function s(e,t){return new Promise((async(s,n)=>{const a=new Image;a.onload=async()=>{s(new i(t,await window.createImageBitmap(a)))},a.onerror=()=>{n(new Error(`Failed to load image at ${t}`))},a.src=e+t}))}class n{imageData;_width;_height;constructor(e,t,i){this.imageData=e,this._width=t,this._height=i}static withTransparency(e){const t=new Uint8ClampedArray(e);for(let e=0;e<t.length;e+=4)255===t[e]&&0===t[e+1]&&255===t[e+2]&&(t[e+3]=0);return t}toImageBitmap(){const e=new OffscreenCanvas(this.width,this.height),t=e.getContext("2d");if(null==t)throw new Error("Could not create context from off screen canvas.");const i=new ImageData(this.imageData,this._width,this._height);return t.putImageData(i,0,0),e.transferToImageBitmap()}get width(){return this._width}get height(){return this._height}setPixel([e,t],i){const s=4*(t*this._width+e),n=this.imageData;n[s]=i.r,n[s+1]=i.g,n[s+2]=i.b,n[s+3]=i.a}getPixel([e,t]){const i=4*(t*this._width+e),s=this.imageData;return{r:s[i],g:s[i+1],b:s[i+2],a:s[i+3]}}static createBlank(e,t){const i=new Uint8ClampedArray(e*t*4);return i.fill(255),new n(i,e,t)}fillWithColor(e){const{r:t,g:i,b:s,a:n}=e;for(let e=0;e<this.imageData.length;e+=4)this.imageData[e]=t,this.imageData[e+1]=i,this.imageData[e+2]=s,this.imageData[e+3]=n}fillColorRect(e,t){for(let i=e.y;i<e.y+e.height;i++)for(let s=e.x;s<e.x+e.width;s++){const e=4*(i*this._width+s);this.imageData[e]=t.r,this.imageData[e+1]=t.g,this.imageData[e+2]=t.b,this.imageData[e+3]=t.a}}blit(e,t,i,s){let n=4*(s*this._width+i);const a=t.width,r=t.height;for(let o=0;o<r&&o+s<this._height;o++){for(let s=0;s<a&&s+i<this._width;s++){const i=t.x+s,a=t.y+o;if(i>=0&&i<e._width&&a>=0&&a<e._height){const t=4*(a*e._width+i);this.imageData[n]=e.imageData[t],this.imageData[n+1]=e.imageData[t+1],this.imageData[n+2]=e.imageData[t+2],this.imageData[n+3]=e.imageData[t+3]}n+=4}n+=4*(this._width-Math.min(a,this._width-i))}}sample(e,t,i="nearest"){let s,n;if("nearest"!==i){if("bilinear"===i){const i=e*(this._width-1),s=t*(this._height-1),n=Math.floor(i),a=Math.floor(s),r=Math.min(n+1,this._width-1),o=Math.min(a+1,this._height-1),l=i-n,h=s-a,c=this.getColorAt(n,a),d=this.getColorAt(r,a),u=this.getColorAt(n,o),p=this.getColorAt(r,o);return{r:this.interpolate(c.r,d.r,u.r,p.r,l,h),g:this.interpolate(c.g,d.g,u.g,p.g,l,h),b:this.interpolate(c.b,d.b,u.b,p.b,l,h),a:this.interpolate(c.a,d.a,u.a,p.a,l,h)}}throw new Error("Unsupported filter type")}return s=Math.round(e*(this._width-1)),n=Math.round(t*(this._height-1)),this.getColorAt(s,n)}getColorAt(e,t){const i=4*(t*this._width+e),s=this.imageData;return{r:s[i],g:s[i+1],b:s[i+2],a:s[i+3]}}interpolate(e,t,i,s,n,a){return e*(1-n)*(1-a)+t*n*(1-a)+i*(1-n)*a+s*n*a}sampledBlit(e,t,i){for(let s=0;s<i.height;s++)for(let n=0;n<i.width;n++){const a=n/i.width,r=s/i.height,o=t.x+a*t.width,l=t.y+r*t.height,h=e.sample(o/e._width,l/e._height,"nearest"),c=i.x+n,d=i.y+s;if(c>=0&&c<this._width&&d>=0&&d<this._height){const e=4*(d*this._width+c);this.imageData[e]=h.r,this.imageData[e+1]=h.g,this.imageData[e+2]=h.b,this.imageData[e+3]=h.a}}}shade(e,t){const i=t.width,s=t.height;for(let n=0;n<s;n++)for(let a=0;a<i;a++){const r=a/(i-1),o=n/(s-1),l=e(t.x+a,t.y+n,r,o),h=t.x+a,c=t.y+n;if(h>=0&&h<this._width&&c>=0&&c<this._height){const e=4*(c*this._width+h);this.imageData[e]=l.r,this.imageData[e+1]=l.g,this.imageData[e+2]=l.b,this.imageData[e+3]=l.a}}}}function a(e,t){return new Promise((async(s,a)=>{fetch(e+t).then((e=>e.arrayBuffer())).then((e=>{const r=new DataView(e);if(16973!==r.getUint16(0,!1))return void a(new Error("Not a valid BMP file"));const o=r.getUint32(18,!0),l=r.getUint32(22,!0),h=r.getUint32(10,!0),c=new Uint8ClampedArray(e,h),d=new Uint8ClampedArray(o*l*4);for(let e=0;e<l;e++)for(let t=0;t<o;t++){const i=4*(e*o+t),s=4*((l-e-1)*o+t);d[s]=c[i+2],d[s+1]=c[i+1],d[s+2]=c[i+0],d[s+3]=c[i+3]}s(new i(t,new n(d,o,l)))})).catch((e=>{a(new Error("Error loading the file"))}))}))}function r(e,t){return new Promise((async(s,n)=>{const a=await fetch(e+t);a.ok?s(new i(t,await a.json())):n(new Error(`Failed to load JSON at ${t}`))}))}class o{loaders=new Map([["png",s],["json",r],["bmp",a]]);addLoader(e,t){this.loaders.set(e,t)}getFileExtension(e){const t=e.match(/\.([0-9a-z]+)(?:[\?#]|$)/i);return t?t[1]:""}getLoaderPromise(e,t){let s=this.getFileExtension(t);return this.loaders.has(s)?this.loaders.get(s)?.(e,t)??Promise.resolve(new i(t,null)):(console.error(`Unknown asset type: ${s}`),Promise.resolve(new i(t,null)))}async loadAssets_ex(e,t){const i=t.map((t=>this.getLoaderPromise(e,t)));try{return await Promise.all(i)}catch(e){throw console.error("Error loading assets:",e),e}}loadAssets(e,t,i){this.loadAssets_ex(e,t).then((e=>{let t=new Map;e.forEach((e=>t.set(e.path,e))),i(t)})).catch((e=>{console.error("Asset loading failed:",e)}))}}function l(e,t){for(let i in e)t[i]=e[i];return t}function h(e,t,i,s){if(null!=i){if("string"==typeof i)return t.getAsset(i).asset;{let n=l(i,new s);return"resolveDependencies"in n&&n.resolveDependencies(e,t),n}}}function c(e){return(t,s)=>new Promise((async(n,a)=>{const r=await fetch(t+s);if(!r.ok)return void a(new Error(`Failed to load JSON at ${s}`));let o=await r.json(),h=e();l(o,h),n(new i(s,h))}))}class d{static typeMap;constructor(){}static addComponentType(e,t){d.typeMap??=new Map,d.typeMap.set(e,t),console.log(e)}static create(e,t){const i=d.typeMap.get(e);return i?new i(t):new m(t)}static createFromPrototype(e,t){let i=d.create(e.type,t);return l(e,i),i}}var u=function(e,t,i,s,n,a){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var o,l=s.kind,h="getter"===l?"get":"setter"===l?"set":"value",c=!t&&e?s.static?e:e.prototype:null,d=t||(c?Object.getOwnPropertyDescriptor(c,s.name):{}),u=!1,p=i.length-1;p>=0;p--){var f={};for(var m in s)f[m]="access"===m?{}:s[m];for(var m in s.access)f.access[m]=s.access[m];f.addInitializer=function(e){if(u)throw new TypeError("Cannot add initializers after decoration has completed");a.push(r(e||null))};var g=(0,i[p])("accessor"===l?{get:d.get,set:d.set}:d[h],f);if("accessor"===l){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(o=r(g.get))&&(d.get=o),(o=r(g.set))&&(d.set=o),(o=r(g.init))&&n.unshift(o)}else(o=r(g))&&("field"===l?n.unshift(o):d[h]=o)}c&&Object.defineProperty(c,s.name,d),u=!0},p=function(e,t,i){for(var s=arguments.length>2,n=0;n<t.length;n++)i=s?t[n].call(e,i):t[n].call(e);return s?i:void 0};function f(e){return function(t){d.addComponentType(e,t)}}let m=(()=>{let e,t,i=[f("Component")],s=[];(class{static{t=this}static{const n="function"==typeof Symbol&&Symbol.metadata?Object.create(null):void 0;u(null,e={value:t},i,{kind:"class",name:t.name,metadata:n},null,s),t=e.value,n&&Object.defineProperty(t,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:n}),p(t,s)}parent;constructor(e){this.parent=e}initialize(e,t,i){}});return t})();class g{entityCreated(e){}update(){}render(e,t){}}class w{static lastTime=performance.now();static deltaTime=0;static update(){const e=performance.now();this.deltaTime=(e-this.lastTime)/1e3,this.lastTime=e}static getDeltaTime(){return this.deltaTime}}var y;!function(e){e[e.Ground=0]="Ground",e[e.Objects=1]="Objects",e[e.Lighting=2]="Lighting",e[e.Overlay=3]="Overlay",e[e.GUI=4]="GUI"}(y||(y={}));const v={Ground:y.Ground,Objects:y.Objects,Lighting:y.Lighting,Overlay:y.Overlay,GUI:y.GUI};class b{x;y;constructor(e,t){this.x=e,this.y=t}copy(){return new b(this.x,this.y)}add(e){return new b(this.x+e.x,this.y+e.y)}negate(){return new b(-this.x,-this.y)}sub(e){return new b(this.x-e.x,this.y-e.y)}truncate(){return new b(Math.floor(this.x),Math.floor(this.y))}}class x{x;y;width;height;constructor(e,t,i,s){this.x=Math.trunc(e),this.y=Math.trunc(t),this.width=Math.trunc(i),this.height=Math.trunc(s)}set(e,t){this.x=e.x-t.x/2,this.y=e.y-t.y/2,this.width=t.x,this.height=t.y}overlaps(e){return this.x<e.x+e.width&&this.x+this.width>e.x&&this.y<e.y+e.height&&this.y+this.height>e.y}get area(){return this.width*this.height}static enumerate(e,t){for(let i=e.y;i<e.y+e.height;i++)for(let s=e.x;s<e.x+e.width;s++)t(s,i)}static getRelativeDirection(e,t){return t.x>=e.x+e.width?"east":t.x+t.width<=e.x?"west":t.y>=e.y+e.height?"south":t.y+t.height<=e.y?"north":"huh?"}}var D=function(e,t,i,s,n,a){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var o,l=s.kind,h="getter"===l?"get":"setter"===l?"set":"value",c=!t&&e?s.static?e:e.prototype:null,d=t||(c?Object.getOwnPropertyDescriptor(c,s.name):{}),u=!1,p=i.length-1;p>=0;p--){var f={};for(var m in s)f[m]="access"===m?{}:s[m];for(var m in s.access)f.access[m]=s.access[m];f.addInitializer=function(e){if(u)throw new TypeError("Cannot add initializers after decoration has completed");a.push(r(e||null))};var g=(0,i[p])("accessor"===l?{get:d.get,set:d.set}:d[h],f);if("accessor"===l){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(o=r(g.get))&&(d.get=o),(o=r(g.set))&&(d.set=o),(o=r(g.init))&&n.unshift(o)}else(o=r(g))&&("field"===l?n.unshift(o):d[h]=o)}c&&Object.defineProperty(c,s.name,d),u=!0},j=function(e,t,i){for(var s=arguments.length>2,n=0;n<t.length;n++)i=s?t[n].call(e,i):t[n].call(e);return s?i:void 0};class A extends m{renderLayer=y.Ground;render(e){}}(()=>{let e,t,i=[f("DebugGizmo")],s=[],n=A;(class extends n{static{t=this}static{const a="function"==typeof Symbol&&Symbol.metadata?Object.create(n[Symbol.metadata]??null):void 0;D(null,e={value:t},i,{kind:"class",name:t.name,metadata:a},null,s),t=e.value,a&&Object.defineProperty(t,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:a}),j(t,s)}point=null;initialize(e,t,i){this.point=e.getAsset("assets/point.png").asset,this.renderLayer=y.Overlay}render(e){e.drawRectangle(this.parent.globalBounds,"rgba(255, 0, 0, 0.5)"),null!=this.point&&e.drawImage(this.point,new x(0,0,this.point.width,this.point.height),new b(this.parent.globalPosition.x-2,this.parent.globalPosition.y-2))}})})();class E extends g{renderables=[];animatables=[];camera=null;fpsQueue;isRenderable(e){return"render"in e}isAnimatable(e){return"animate"in e}constructor(){super(),this.fpsQueue=[]}entityCreated(e){e.components.forEach((e=>{this.isRenderable(e)&&this.renderables.push(e),this.isAnimatable(e)&&this.animatables.push(e)}))}render(e,t){if(this.animatables.forEach((e=>e.animate())),null!=this.camera){t.context.globalAlpha=1,t.context.globalCompositeOperation="source-over";for(let e in y){let i=Number(y[e]);if(!Number.isNaN(i)){for(let e of this.renderables)e.renderLayer==i&&e.render(t);t.flush(this.camera)}}this.fpsQueue.push(w.getDeltaTime()),this.fpsQueue.length>200&&this.fpsQueue.shift(),t.context.fillStyle="black",t.context.textAlign="left",t.context.textBaseline="top"}}setCamera(e){this.camera=e}}class O{canvas;context;pendingDrawTasks;constructor(e,t){this.canvas=e,this.context=t,this.pendingDrawTasks=[]}drawSprite(e,t){let i=t.truncate();this.pendingDrawTasks.push(((t,s)=>{t.drawImage(e.image,e.sourceRect.x,e.sourceRect.y,e.sourceRect.width,e.sourceRect.height,i.x+s.drawOffset.x,i.y+s.drawOffset.y,e.sourceRect.width,e.sourceRect.height)}))}drawImage(e,t,i){let s=i.truncate();this.pendingDrawTasks.push(((i,n)=>{i.drawImage(e,t.x,t.y,t.width,t.height,s.x+n.drawOffset.x,s.y+n.drawOffset.y,t.width,t.height)}))}drawRectangle(e,t){this.pendingDrawTasks.push(((i,s)=>{i.fillStyle=t,i.fillRect(Math.floor(e.x)+s.drawOffset.x,Math.floor(e.y)+s.drawOffset.y,e.width,e.height)}))}drawString(e,t,i){this.pendingDrawTasks.push(((s,n)=>{s.fillStyle=i,s.textAlign="left",s.textBaseline="top",s.fillText(e,t.x+n.drawOffset.x,t.y+n.drawOffset.y)}))}drawLine(e,t,i){this.pendingDrawTasks.push(((s,n)=>{s.strokeStyle=i,s.beginPath(),s.moveTo(e.x+n.drawOffset.x,e.y+n.drawOffset.y),s.lineTo(t.x+n.drawOffset.x,t.y+n.drawOffset.y),s.stroke()}))}flush(e){this.context.globalAlpha=1,this.context.globalCompositeOperation="source-over";let t=new b(this.canvas.width/2,this.canvas.height/2);e.drawOffset=e.position.negate().add(t).truncate();for(let t of this.pendingDrawTasks)t(this.context,e);this.pendingDrawTasks=[]}clearScreen(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}}class P{ID;parent;name="unnamed";storageNode=null;localPosition=new b(0,0);get globalPosition(){return this.parent?this.parent.globalPosition.add(this.localPosition):this.localPosition}get localBounds(){return new x(this.localPosition.x+this.rect.x,this.localPosition.y+this.rect.y,this.rect.width,this.rect.height)}get globalBounds(){let e=this.globalPosition;return new x(e.x+this.rect.x,e.y+this.rect.y,this.rect.width,this.rect.height)}pivot=new b(0,0);rect=new x(0,0,1,1);components;children;constructor(e){this.ID=e,this.parent=null,this.components=[],this.children=[]}addChild(e){e.parent=this,this.children.push(e)}getComponent(e){return this.components.find((t=>t instanceof e))}}let T=1;class C{modules=[];assetMap;sceneRoot;debugMode=!1;fpsQueue;constructor(e){this.assetMap=e;for(const[,t]of e)t.resolveDependencies(this);this.sceneRoot=new P(0),this.fpsQueue=[]}getAsset(e){return this.assetMap?.get(e)??new i(e,null)}update(){let e=performance.now();for(let e of this.modules)e.update();let t=performance.now();this.fpsQueue.push(t-e),this.fpsQueue.length>200&&this.fpsQueue.shift()}render(e){for(let t of this.modules)t.render(this,e);this.fpsQueue.reduce(((e,t)=>e+t),0),this.fpsQueue.length;e.context.fillStyle="black",e.context.textAlign="left",e.context.textBaseline="top"}run(e,t){w.update(),this.update(),t(),e.clearScreen(),this.render(e),requestAnimationFrame((()=>this.run(e,t)))}addModule(e){this.modules.push(e)}createEntityFromPrototype(e,t,i){let s=T++,n=new P(s);e.addChild(n);let a=t.asset;return l(a,n),n.components=a.components.map((e=>d.createFromPrototype(e,n))),n.components.forEach((e=>e.parent=n)),n.components.forEach((e=>e.initialize(this,i,t))),this.modules.forEach((e=>e.entityCreated(n))),n}createEntitytFromTiledTemplate(e,t){if(null==t.object?.properties)return console.error("Can't create entity from template without a prototype."),null;let i=t.object.properties.find((e=>"prototype"==e.name));if(null==i?.value)return console.error("Can't create entity from template without a prototype."),null;let s=this.getAsset(i.value);if(null==s)return console.error(`Could not find prototype ${i.value}.`),null;let n=this.createEntityFromPrototype(e,s,t);return null!=t.object.name&&null!==t.object.name&&""!=t.object.name&&(n.name=t.object.name),n}createEntityFromTiledObject(e,t){if(null==t.templateAsset)return null;let i=this.createEntitytFromTiledTemplate(e,t.templateAsset.asset);return null!=i&&(i.localPosition=new b(t.x??0,t.y??0),void 0!==t.name&&""!=t.name&&(i.name=t.name)),i}}class I{components=[]}var S;!function(e){e[e.Empty=0]="Empty",e[e.Priming=1]="Priming",e[e.Ready=2]="Ready"}(S||(S={}));var M=function(e,t,i,s,n,a){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var o,l=s.kind,h="getter"===l?"get":"setter"===l?"set":"value",c=!t&&e?s.static?e:e.prototype:null,d=t||(c?Object.getOwnPropertyDescriptor(c,s.name):{}),u=!1,p=i.length-1;p>=0;p--){var f={};for(var m in s)f[m]="access"===m?{}:s[m];for(var m in s.access)f.access[m]=s.access[m];f.addInitializer=function(e){if(u)throw new TypeError("Cannot add initializers after decoration has completed");a.push(r(e||null))};var g=(0,i[p])("accessor"===l?{get:d.get,set:d.set}:d[h],f);if("accessor"===l){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(o=r(g.get))&&(d.get=o),(o=r(g.set))&&(d.set=o),(o=r(g.init))&&n.unshift(o)}else(o=r(g))&&("field"===l?n.unshift(o):d[h]=o)}c&&Object.defineProperty(c,s.name,d),u=!0},k=function(e,t,i){for(var s=arguments.length>2,n=0;n<t.length;n++)i=s?t[n].call(e,i):t[n].call(e);return s?i:void 0};let _=(()=>{let e,t,i=[f("Tilemap")],s=[],n=A;(class extends n{static{t=this}static{const a="function"==typeof Symbol&&Symbol.metadata?Object.create(n[Symbol.metadata]??null):void 0;M(null,e={value:t},i,{kind:"class",name:t.name,metadata:a},null,s),t=e.value,a&&Object.defineProperty(t,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:a}),k(t,s)}layer=void 0;tilemap=void 0;cacheState=S.Empty;cachedCanvas=void 0;cachedRender=void 0;initialize(e,t){}getTile(e,t){if(null==e.tilesets)return[null,0];for(let i=e.tilesets.length-1;i>=0;i--)if(t>(e.tilesets[i].firstgid??0))return[e.tilesets[i],t-(e.tilesets[i].firstgid??0)];return[e?.tilesets[0],t]}updateCache(){if(null==this.layer||null==this.tilemap)return;this.cacheState=S.Priming;const e=new b((this.layer.width??1)*(this.tilemap.tilewidth??16),(this.layer.height??1)*(this.tilemap.tileheight??16));this.cachedCanvas=new OffscreenCanvas(e.x,e.y);let t=this.cachedCanvas.getContext("2d");if(null!=t){for(let e=0;e<(this.layer.width??1);++e)for(let i=0;i<(this.layer.height??1);++i){let s=0;if(null!=this.layer.data&&(s=this.layer.data[i*(this.layer.width??1)+e]??0),0==s)continue;let[n,a]=this.getTile(this.tilemap,s),r=n?.tilesetAsset?.getTileRect(a??0);null!=r&&(null!=n?.tilesetAsset?.imageAsset&&t.drawImage(n.tilesetAsset?.imageAsset,r.x,r.y,r.width,r.height,e*(this.tilemap.tilewidth??16),i*(this.tilemap.tileheight??16),this.tilemap.tilewidth??16,this.tilemap.tileheight??16))}createImageBitmap(this.cachedCanvas).then((e=>{this.cachedRender=e,this.cacheState=S.Ready}))}}render(e){this.cacheState==S.Empty&&this.updateCache();let t=this.parent.globalPosition;t.x+=this.layer?.x??0,t.y+=this.layer?.y??0,this.cacheState==S.Priming&&null!=this.cachedCanvas?e.drawImage(this.cachedCanvas,new x(0,0,this.cachedCanvas.width,this.cachedCanvas.height),t):this.cacheState==S.Ready&&null!=this.cachedRender&&e.drawImage(this.cachedRender,new x(0,0,this.cachedRender.width,this.cachedRender.height),t)}});return t})();function R(...e){let t=[];Array.from(Array.isArray(e[0])?e[0]:e).forEach((e=>t=t.concat(e.split("/"))));let i=[];return t.forEach((e=>{""!=e&&"/"!=e&&"."!=e&&(".."==e?i.pop():i.push(e))})),i.join("/")}class F{name=void 0;type=void 0;value=void 0}class L{gid=void 0;height=void 0;id=void 0;name=void 0;polygon=void 0;properties=void 0;rotation=void 0;template=void 0;type=void 0;visible=void 0;width=void 0;x=void 0;y=void 0;templateAsset=void 0;resolveDependencies(e,t){null!=this.template&&""!=this.template&&(this.templateAsset=t.assetMap.get(R(e.directory(),this.template))),null!=this.properties&&(this.properties=this.properties.map((e=>{let t=new F;return l(e,t),t}))),null!=this.polygon&&(this.polygon=this.polygon.map((e=>new b(e.x,e.y))))}}class z{draworder=void 0;id=void 0;name=void 0;objects=void 0;opacity=void 0;type=void 0;visible=void 0;x=void 0;y=void 0;resolveDependencies(e,t){null!=this.objects&&(this.objects=this.objects.map((e=>{let t=new L;return l(e,t),t})),this.objects.forEach((i=>i.resolveDependencies(e,t))))}}class B{id=void 0;objectgroup=void 0;resolveDependencies(e,t){if(null!=this.objectgroup){let e=new z;l(this.objectgroup,e),this.objectgroup=e}}}class U{columns=void 0;image=void 0;imageheight=void 0;imagewidth=void 0;margin=void 0;name=void 0;spacing=void 0;tilecount=void 0;tiledversion=void 0;tileheight=void 0;tiles=void 0;tilewidth=void 0;type=void 0;version=void 0;imageAsset=void 0;resolveDependencies(e,t){null!=this.image&&(this.imageAsset=t.getAsset(R(e.directory(),this.image)).asset),null!=this.tiles&&(this.tiles=this.tiles.map((e=>{let t=new B;return l(e,t),t})),this.tiles.forEach((i=>i.resolveDependencies(e,t))))}getTileRect(e){return new x(e%(this.columns??1)*(this.tilewidth??16),Math.floor(e/(this.columns??1))*(this.tileheight??16),this.tilewidth??16,this.tileheight??16)}}class N{class=void 0;data=void 0;draworder=void 0;height=void 0;id=void 0;name=void 0;objects=void 0;opacity=void 0;type=void 0;visible=void 0;width=void 0;x=void 0;y=void 0;resolveDependencies(e,t){null!=this.objects&&(this.objects=this.objects.map((e=>{let t=new L;return l(e,t),t})),this.objects.forEach((i=>i.resolveDependencies(e,t))))}}class Q{firstgid=void 0;source=void 0;tilesetAsset=void 0;resolveDependencies(e,t){null!=this.source&&(this.tilesetAsset=t.getAsset(R(e.directory(),this.source)).asset)}}class G{compressionlevel=void 0;height=void 0;infinite=void 0;layers=void 0;nexlayerid=void 0;nextobjectid=void 0;orientation=void 0;renderorder=void 0;tiledversion=void 0;tileheight=void 0;tilesets=void 0;tilewidth=void 0;type=void 0;version=void 0;width=void 0;resolveDependencies(e,t){this.tilesets=this.tilesets?.map((e=>{let t=new Q;return l(e,t),t})),this.tilesets?.forEach((i=>i.resolveDependencies(e,t))),this.layers=this.layers?.map((e=>{let t=new N;return l(e,t),t})),this.layers?.forEach((i=>i.resolveDependencies(e,t)))}}class H{fileName=void 0;height=void 0;width=void 0;x=void 0;y=void 0;tilemapAsset=void 0;resolveDependencies(e,t){this.tilemapAsset=t.getAsset(e.directory()+this.fileName).asset}}class ${maps=void 0;onlyShowAdjacentMaps=void 0;type=void 0;resolveDependencies(e,t){this.maps=this.maps?.map((e=>{let t=new H;return l(e,t),t})),this.maps?.forEach((i=>i.resolveDependencies(e,t)))}}class W{object=void 0;tileset=void 0;type=void 0;basePath=void 0;resolveDependencies(e,t){if(this.basePath=e.directory(),null!=this.tileset){let i=new Q;l(this.tileset,i),this.tileset=i,this.tileset.resolveDependencies(e,t)}if(null!=this.object){let i=new L;l(this.object,i),this.object=i,i.resolveDependencies(e,t)}}}class K{position=new b(0,0);drawOffset=new b(0,0);bounds=new x(-.5,-.5,1,1)}class J extends g{updateables=[];isUpdateable(e){return"update"in e}entityCreated(e){e.components.forEach((e=>{this.isUpdateable(e)&&this.updateables.push(e)}))}update(){for(let e of this.updateables)e.update()}}class q{name=void 0;direction=void 0;frames=[];resolveDependencies(e,t){this.frames??=[],this.frames=this.frames.map((e=>l(e,new b(0,0))))}}class V{animations=[];resolveDependencies(e,t){this.animations??=[],this.animations=this.animations.map((e=>l(e,new q))),this.animations.forEach((i=>i.resolveDependencies(e,t)))}getAnimation(e,t){if(null==this.animations)return null;for(let i of this.animations)if(i.name==e&&(null==t||i.direction==t))return i;return null!=t?this.getAnimation(e,void 0):null}}class X{indices;width;height;constructor(e,t){this.width=e.width,this.height=e.height,this.indices=[];for(let i=0;i<this.height;i++)for(let s=0;s<this.width;s++){const n=e.getPixel([s,i]);let a=t.getIndex(n);-1==a&&(a=0),this.indices.push(a)}}getIndex(e,t){return this.indices[t*this.width+e]}toImageBitmap(e){const t=new OffscreenCanvas(this.width,this.height),i=t.getContext("2d");if(null==i)throw new Error("Could not create context from off screen canvas.");const s=i.createImageData(this.width,this.height),n=s.data;for(let t=0;t<this.indices.length;t++){const i=e.getColor(this.indices[t]),s=4*t;n[s]=i.r,n[s+1]=i.g,n[s+2]=i.b,n[s+3]=i.a,255==i.r&&0==i.g&&255==i.b&&(n[s+3]=0)}return i.putImageData(s,0,0),t.transferToImageBitmap()}}class Y{colors;rawImage;constructor(e,t){this.colors=[],this.rawImage=e;const i=e.width;for(let s=0;s<i;s++){const i=e.getPixel([s,t]);this.colors.push(i)}}getColor(e){return this.colors[e]}getIndex(e){return this.colors.findIndex((t=>t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a))}}class Z{baseImage=null;palette=null;constructor(e,t){this.baseImage=e,this.palette=t}}class ee{layers=[];compose(){let e=0,t=0;if(this.layers.forEach((i=>{null!=i.baseImage&&(i.baseImage.width>e&&(e=i.baseImage.width),i.baseImage.height>t&&(t=i.baseImage.height))})),0==e||0==t)return null;const i=new OffscreenCanvas(e,t),s=i.getContext("2d");if(null==s)throw new Error("Could not create context from off screen canvas.");return this.layers.forEach((e=>{if(null!=e.baseImage&&null!=e.palette){let t=e.baseImage?.toImageBitmap(e.palette);s.drawImage(t,0,0)}})),i.transferToImageBitmap()}}class te{image;sourceRect;constructor(e,t){this.image=e,this.sourceRect=t}}class ie{sheet=void 0;palette=void 0}class se{type=void 0;path=void 0;basePalette=void 0;layers=void 0;isSheet=void 0;tileWidth=void 0;tileHeight=void 0;animations=void 0;fps=void 0;currentAnimation=void 0;cachedImage=null;resolveDependencies(e,t){null!=this.layers&&(this.layers=this.layers.map((e=>{let t=new ie;return l(e,t),t}))),this.isSheet??=!1,this.animations=h(e,t,this.animations,V),this.fps??=10,this.loadImageCache(t)}loadImageCache(e){if("composite"==this.type){let t=new Y(e.getAsset(this.basePalette??"").asset,0),i=new ee;if(null!=this.layers)for(let s of this.layers)i.layers.push(new Z(new X(e.getAsset(s.sheet??"").asset,t),new Y(t.rawImage,s.palette??0)));this.cachedImage=i.compose()}"image"==this.type&&(this.cachedImage=e.getAsset(this.path??"").asset)}getSprite(e,t){if(null==this.cachedImage)throw new Error("No cached image");return 0==this.isSheet?new te(this.cachedImage,new x(0,0,this.cachedImage?.width??1,this.cachedImage?.height??1)):new te(this.cachedImage,new x(e*(this.tileWidth??0),t*(this.tileHeight??0),this.tileWidth??1,this.tileHeight??1))}}var ne=function(e,t,i,s,n,a){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var o,l=s.kind,h="getter"===l?"get":"setter"===l?"set":"value",c=!t&&e?s.static?e:e.prototype:null,d=t||(c?Object.getOwnPropertyDescriptor(c,s.name):{}),u=!1,p=i.length-1;p>=0;p--){var f={};for(var m in s)f[m]="access"===m?{}:s[m];for(var m in s.access)f.access[m]=s.access[m];f.addInitializer=function(e){if(u)throw new TypeError("Cannot add initializers after decoration has completed");a.push(r(e||null))};var g=(0,i[p])("accessor"===l?{get:d.get,set:d.set}:d[h],f);if("accessor"===l){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(o=r(g.get))&&(d.get=o),(o=r(g.set))&&(d.set=o),(o=r(g.init))&&n.unshift(o)}else(o=r(g))&&("field"===l?n.unshift(o):d[h]=o)}c&&Object.defineProperty(c,s.name,d),u=!0},ae=function(e,t,i){for(var s=arguments.length>2,n=0;n<t.length;n++)i=s?t[n].call(e,i):t[n].call(e);return s?i:void 0};let re=(()=>{let e,t,i=[f("Sprite")],s=[],n=A;(class extends n{static{t=this}static{const a="function"==typeof Symbol&&Symbol.metadata?Object.create(n[Symbol.metadata]??null):void 0;ne(null,e={value:t},i,{kind:"class",name:t.name,metadata:a},null,s),t=e.value,a&&Object.defineProperty(t,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:a}),ae(t,s)}sprite=null;gfx=void 0;frame=void 0;currentAnimation=null;currentPlace=0;facing=void 0;render(e){null!=this.sprite&&e.drawSprite(this.sprite,this.parent.globalPosition.sub(this.parent.pivot))}initialize(e,t,i){if(this.renderLayer=y.Objects,this.gfx=h(i,e,this.gfx,se),this.facing??="south",null!=this.gfx&&(null==this.frame?this.sprite=this.gfx.getSprite(0,0):this.sprite=this.gfx.getSprite(this.frame.x,this.frame.y)),null!=this.gfx)if(null==this.gfx.animations)this.currentAnimation=new q,this.currentAnimation.frames=[new b(0,0)];else if(null!=this.gfx.currentAnimation)this.currentAnimation=this.gfx.animations.getAnimation(this.gfx.currentAnimation,this.facing);else if(null!=this.gfx.animations.animations){let e=this.gfx?.animations?.animations[0];this.currentAnimation=null==e?null:e}}playAnimation(e,t){null!=this.gfx&&(this.currentAnimation=this.gfx.animations?.getAnimation(e,this.facing)??null,t&&(this.currentPlace=0))}animate(){if(null!=this.sprite&&null!=this.currentAnimation&&null!=this.gfx?.fps&&null!=this.currentAnimation.frames){this.currentPlace+=w.getDeltaTime();let e=Math.floor(this.currentPlace/(1/this.gfx.fps))%this.currentAnimation.frames.length;this.sprite=this.gfx.getSprite(this.currentAnimation.frames[e].x,this.currentAnimation.frames[e].y)}}});return t})();class oe{inputEvents=[];maxHistoryTime=5e3;actionMap={};initialize(){window.addEventListener("keydown",function(e){const t=this.actionMap[e.code];if(!t)return;this.inputEvents.find((e=>e.action===t&&e.pressed))||this.inputEvents.push({action:t,pressed:!0,downTime:performance.now(),upTime:null,handled:!1})}.bind(this)),window.addEventListener("keyup",function(e){const t=this.actionMap[e.code];if(!t)return;const i=this.inputEvents.find((e=>e.action===t&&e.pressed));i&&(i.pressed=!1,i.upTime=performance.now())}.bind(this))}bind(e,t){this.actionMap[e]=t}tryGetRecentInput(e,t){const i=performance.now();for(const s of this.inputEvents)if(s.action===e&&!s.handled&&(i-s.downTime<=t||!s.pressed&&s.upTime&&i-s.upTime<=t))return s;return null}check(e){for(const t of this.inputEvents)if(t.action===e&&!t.handled&&t.pressed)return!0;return!1}markHandled(e){for(const t of this.inputEvents)t.action===e&&(t.handled=!0)}cleanup(){const e=performance.now();for(let t=this.inputEvents.length-1;t>=0;t--){const i=this.inputEvents[t];if(i.pressed)continue;e-(i.upTime??0)>this.maxHistoryTime&&this.inputEvents.splice(t,1)}}}var le=function(e,t,i,s,n,a){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var o,l=s.kind,h="getter"===l?"get":"setter"===l?"set":"value",c=!t&&e?s.static?e:e.prototype:null,d=t||(c?Object.getOwnPropertyDescriptor(c,s.name):{}),u=!1,p=i.length-1;p>=0;p--){var f={};for(var m in s)f[m]="access"===m?{}:s[m];for(var m in s.access)f.access[m]=s.access[m];f.addInitializer=function(e){if(u)throw new TypeError("Cannot add initializers after decoration has completed");a.push(r(e||null))};var g=(0,i[p])("accessor"===l?{get:d.get,set:d.set}:d[h],f);if("accessor"===l){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(o=r(g.get))&&(d.get=o),(o=r(g.set))&&(d.set=o),(o=r(g.init))&&n.unshift(o)}else(o=r(g))&&("field"===l?n.unshift(o):d[h]=o)}c&&Object.defineProperty(c,s.name,d),u=!0},he=function(e,t,i){for(var s=arguments.length>2,n=0;n<t.length;n++)i=s?t[n].call(e,i):t[n].call(e);return s?i:void 0};(()=>{let e,t,i=[f("PlayerController")],s=[],n=m;(class extends n{static{t=this}static{const a="function"==typeof Symbol&&Symbol.metadata?Object.create(n[Symbol.metadata]??null):void 0;le(null,e={value:t},i,{kind:"class",name:t.name,metadata:a},null,s),t=e.value,a&&Object.defineProperty(t,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:a}),he(t,s)}input=null;speed=32;sprite=void 0;initialize(e,t){this.input=new oe,this.input.bind("KeyA","west"),this.input.bind("KeyW","north"),this.input.bind("KeyS","south"),this.input.bind("KeyD","east"),this.input.initialize(),this.sprite=this.parent.getComponent(re)}update(){this.input?.check("west")&&(this.parent.localPosition.x-=this.speed*w.getDeltaTime(),null!=this.sprite&&(this.sprite.facing="west",this.sprite.playAnimation("walk",!1))),this.input?.check("north")&&(this.parent.localPosition.y-=this.speed*w.getDeltaTime(),null!=this.sprite&&(this.sprite.facing="north",this.sprite.playAnimation("walk",!1))),this.input?.check("south")&&(this.parent.localPosition.y+=this.speed*w.getDeltaTime(),null!=this.sprite&&(this.sprite.facing="south",this.sprite.playAnimation("walk",!1))),this.input?.check("east")&&(this.parent.localPosition.x+=this.speed*w.getDeltaTime(),null!=this.sprite&&(this.sprite.facing="east",this.sprite.playAnimation("walk",!1))),this.input?.cleanup()}})})();class ce{seed;constructor(e){this.seed=e}NextFloat(){let e=1e4*Math.sin(this.seed++);return e-Math.floor(e)}NextInt(e,t){return Math.floor(this.NextFloat()*(t-e+1))+e}}new b(8,7);function Run(){console.log("Starting Engine"),r("data/","manifest.json").then((e=>{let t=e.asset;const s=document.getElementById("myCanvas");s.style.imageRendering="pixelated";const n=s.getContext("2d");if(null==n)return void console.error("Failed to get context");n.imageSmoothingEnabled=!1;const a=new o;a.addLoader("tmj",c((()=>new G))),a.addLoader("tsj",c((()=>new U))),a.addLoader("world",c((()=>new $))),a.addLoader("tj",c((()=>new W))),a.addLoader("proto",c((()=>new I))),a.addLoader("anim",c((()=>new Animation))),a.addLoader("gfx",c((()=>new se))),a.addLoader("animset",c((()=>new V))),a.loadAssets("data/",t,(e=>{const t=new C(e);new ce(6);t.debugMode=!0,t.addModule(new J);let a=new E;t.addModule(a);let r=new K;a.setCamera(r),r.position=new b(0,0),function(e,t){let s=e.getAsset(t).asset,n=[];if(s.layers)for(let t of s.layers)if("objectgroup"==t.type)n.push(...de(e,t));else if("tilelayer"==t.type){let a=new I,r=new i("",a);a.components.push({type:"Tilemap",tilemap:s,layer:t});let o=e.createEntityFromPrototype(e.sceneRoot,r,new W),l=o.getComponent(_);null!=l&&null!=t.class&&(l.renderLayer=v[t.class]),n.push(o)}}(t,"assets/untitled3.tmj");let o=new O(s,n);t.run(o,(()=>{console.log("Frame!")}))}))})).catch((e=>console.error("Failed to load asset manifest.")))}function de(e,t){let i=[];if(t.objects)for(let s of t.objects)if(null!=s.template&&""!=s.template){let t=e.createEntityFromTiledObject(e.sceneRoot,s);t&&i.push(t)}return i}return t})()));